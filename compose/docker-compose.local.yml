
services:

  redis:
    image: redis:7
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data

  mysql:
    image: mysql:8
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-mydb}
      MYSQL_USER: ${MYSQL_USER:-user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-pass}
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql-data:/var/lib/mysql

  phpmyadmin:
    image: phpmyadmin:5
    environment:
      PMA_HOST: mysql
      PMA_PORT: "${MYSQL_PORT:-3306}:3306"
      # Optional: allows larger imports (adjust if needed)
      UPLOAD_LIMIT: 256M
    ports:
      - "${PHPMYADMIN_PORT:-8082}:80"
    depends_on:
      - mysql


  ## ðŸ” Keycloak
  keycloak:
    image: quay.io/keycloak/keycloak:24.0.1
    command: start-dev
    environment:
      KC_DB: postgres
      KC_DB_URL_HOST: keycloak-db
      KC_DB_URL_DATABASE: keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: password
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "18080:8080"
    depends_on:
      - keycloak-db

  keycloak-db:
    image: postgres:13
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - keycloak-db-data:/var/lib/postgresql/data

  ## ðŸ”‘ Infisical (Secrets Management)
  infisical:
    image: infisical/infisical:v0.46.2-postgres
    ports:
      - "${INFISICAL_PORT:-8888}:8080"
    environment:
      # Database
      DB_CONNECTION_URI: postgres://infisical:password@infisical-db:5432/infisical?sslmode=disable
      # Redis for caching
      REDIS_URL: redis://infisical-redis:6379
      # Encryption keys (generated once, keep consistent)
      ENCRYPTION_KEY: 6c6976652d6c6f6e672d656e6f7567682d746f2d62652d33322d62797465
      AUTH_SECRET: 7468697369736d7973757065727365637265746b65796e6f626f64796b6e6f7773
      # Site configuration
      SITE_URL: http://localhost:8888
      # Telemetry (disabled for local dev)
      TELEMETRY_ENABLED: "false"
      # Allow signup for local dev
      INVITE_ONLY_SIGNUP: "false"
    depends_on:
      infisical-db:
        condition: service_healthy
      infisical-redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/api/status"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  infisical-db:
    image: postgres:14
    environment:
      POSTGRES_DB: infisical
      POSTGRES_USER: infisical
      POSTGRES_PASSWORD: password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U infisical -d infisical"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - infisical-db-data:/var/lib/postgresql/data

  infisical-redis:
    image: redis:7
    volumes:
      - infisical-redis-data:/data

  ## ðŸ§ª Unleash
  unleash:
    image: unleashorg/unleash-server:5.8.0
    ports:
      - "4242:4242"
    environment:
      DATABASE_URL: postgres://unleash:password@unleash-db:5432/unleash?sslmode=disable
      NODE_ENV: development
    depends_on:
      - unleash-db

  unleash-db:
    image: postgres:13
    environment:
      POSTGRES_DB: unleash
      POSTGRES_USER: unleash
      POSTGRES_PASSWORD: password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U unleash -d unleash"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - unleash-db-data:/var/lib/postgresql/data

  ## ðŸ” ElasticSearch
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.1
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - "9200:9200"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9200 >/dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30

  ## ðŸ“Š Kibana
  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.1
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      elasticsearch:
        condition: service_healthy
  
  ## ðŸ“¦ Filebeat (ship Docker logs -> Elasticsearch)
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.1
    user: root
    depends_on:
      elasticsearch:
        condition: service_healthy
    volumes:
      # Filebeat config
      - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro

      # Read Docker container logs (Docker Desktop will expose this to containers)
      - /var/lib/docker/containers:/var/lib/docker/containers:ro

      # Enrich events with Docker metadata (container name, labels, image, etc.)
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    command: ["--strict.perms=false"]

  ## ðŸ“ˆ Prometheus
  prometheus:
    image: prom/prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  ## ðŸ“‰ Grafana
  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus
  
  traefik:
    image: traefik:v2.11
    command:
      - --api.dashboard=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
    ports:
      - "80:80"
      - "8081:8080" # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.localhost`)"
      - "traefik.http.routers.traefik.service=api@internal"

  ## ðŸ§© user-api (built from repo Dockerfile)
  user-api:
    build:
      context: ..
      dockerfile: Dockerfile
    image: backender/user-api:local
    env_file:
      - ../.env.local
    environment:
      - ENV=local
      - USER_API_PORT=${USER_API_PORT:-3333}
    ports:
      - "${USER_API_PORT:-3333}:${USER_API_PORT:-3333}"
    depends_on:
      - mysql
      - redis
      - elasticsearch
      - infisical
    labels:
      # Enable Filebeat autodiscover hints for this container
      co.elastic.logs/enabled: "true"
      # user-api emits JSON logs to stdout; parse them
      co.elastic.logs/json.keys_under_root: "true"
      co.elastic.logs/json.add_error_key: "true"
      # Store in a dedicated index per day
      co.elastic.logs/index: "logs-user-api-%{+yyyy.MM.dd}"

volumes:
  redis-data:
  mysql-data:
  keycloak-db-data:
  infisical-db-data:
  infisical-redis-data:
  unleash-db-data:
  es-data:
  grafana-data: